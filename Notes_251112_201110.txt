<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riesgo Crédito Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            /* Fuente ahora cargada */
            font-family: 'Poppins', sans-serif;
            background: #f4f6f9;
            margin: 0;
            padding: 0;
        }
        header {
            background: #1a73e8;
            color: white;
            padding: 1rem 2rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
        }
        main {
            max-width: 1100px;
            margin: 2rem auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        .filtros {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        select, button, input {
            padding: 0.6rem 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            /* ⚠️ MEJORA: Asegurar que los inputs y selects ocupen al menos un espacio decente en pantallas grandes */
            flex-grow: 1; 
            min-width: 180px;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover {
            background: #1559b0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f0f3f8;
        }
        tr:hover {
            background: #f9fbff;
        }
        .alto {color: #e53935; font-weight: bold;}
        .medio {color: #ffb300; font-weight: bold;}
        .bajo {color: #43a047; font-weight: bold;}
    </style>
</head>
<body>
    <header>Riesgo Crédito Pro</header>
    <main>
        <div class="filtros">
            <select id="filtro-empleo">
                <option value="todos">Todos los empleos</option>
                <option value="empleado">Empleados</option>
                <option value="desempleado">Desempleados</option>
            </select>
            <select id="filtro-riesgo">
                <option value="todos">Todos los riesgos</option>
                <option value="alto">Riesgo alto</option>
                <option value="medio">Riesgo medio</option>
                <option value="bajo">Riesgo bajo</option>
            </select>
            <input type="text" id="buscar" placeholder="Buscar por nombre...">
            <button onclick="exportarCSV()">Exportar CSV</button>
        </div>
        <table id="tabla-clientes">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Empleo</th>
                    <th>Ingresos (DOP)</th>
                    <th>Historial</th>
                    <th>Riesgo</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </main>

<script>
    const clientes = [
        { nombre: "Juan Pérez", empleo: "empleado", ingresos: 25000, historial: "bueno" },
        { nombre: "Ana Gómez", empleo: "desempleado", ingresos: 8000, historial: "malo" },
        { nombre: "Carlos Ruiz", empleo: "empleado", ingresos: 15000, historial: "regular" },
        { nombre: "Lucía Fernández", empleo: "desempleado", ingresos: 12000, historial: "malo" },
        { nombre: "Pedro Martínez", empleo: "empleado", ingresos: 30000, historial: "bueno" }
    ];

    function calcularRiesgo(c) {
        let riesgo = 0;
        // La lógica de cálculo de riesgo parece correcta según las reglas definidas implícitamente
        if (c.empleo === "desempleado") riesgo += 40;
        if (c.ingresos < 15000) riesgo += 30;
        if (c.historial === "malo") riesgo += 30;
        
        // Se mantiene la lógica: Alto >= 70, Medio >= 40 (y < 70), Bajo < 40
        if (riesgo >= 70) return {texto: "Alto", clase: "alto"};
        if (riesgo >= 40) return {texto: "Medio", clase: "medio"};
        return {texto: "Bajo", clase: "bajo"};
    }

    function mostrarClientes(lista) {
        const cuerpo = document.querySelector('#tabla-clientes tbody');
        cuerpo.innerHTML = '';
        
        // ⚠️ MEJORA: Usar document.createElement o un array de strings para mejor performance,
        // pero la concatenación con += es aceptable para este tamaño.
        const filasHTML = lista.map(c => {
            const riesgo = calcularRiesgo(c);
            // .toLocaleString() es correcto para formato de números
            return `<tr>
                <td>${c.nombre}</td>
                <td>${c.empleo}</td>
                <td>${c.ingresos.toLocaleString('es-DO', { style: 'currency', currency: 'DOP', minimumFractionDigits: 0 })}</td>
                <td>${c.historial}</td>
                <td class="${riesgo.clase}">${riesgo.texto}</td>
            </tr>`;
        }).join('');
        cuerpo.innerHTML = filasHTML;
    }

    function filtrar() {
        const filtroEmpleo = document.getElementById('filtro-empleo').value;
        // Se asegura que los valores del filtro de riesgo se comparen con el texto de riesgo en minúsculas. CORRECTO.
        const filtroRiesgo = document.getElementById('filtro-riesgo').value;
        const buscar = document.getElementById('buscar').value.toLowerCase();

        const filtrados = clientes.filter(c => {
            const riesgo = calcularRiesgo(c).texto.toLowerCase();
            return (
                (filtroEmpleo === 'todos' || c.empleo === filtroEmpleo) &&
                (filtroRiesgo === 'todos' || riesgo === filtroRiesgo) &&
                (c.nombre.toLowerCase().includes(buscar))
            );
        });
        mostrarClientes(filtrados);
    }

    // Los event listeners para activar la función filtrar están colocados correctamente.
    document.getElementById('filtro-empleo').addEventListener('change', filtrar);
    document.getElementById('filtro-riesgo').addEventListener('change', filtrar);
    document.getElementById('buscar').addEventListener('input', filtrar);

    function exportarCSV() {
        // ⚠️ CORRECCIÓN/MEJORA 2: Se añade el Byte Order Mark (BOM) para asegurar la codificación UTF-8
        // y el correcto manejo de caracteres especiales (como acentos) en el archivo CSV.
        const bom = '\ufeff'; // BOM para UTF-8
        let csv = bom + 'Nombre,Empleo,Ingresos,Historial,Riesgo\n';
        
        // Obtener solo las filas actualmente visibles y filtradas. CORRECTO.
        const filas = document.querySelectorAll('#tabla-clientes tbody tr');
        filas.forEach(tr => {
            const celdas = tr.querySelectorAll('td');
            // Reemplazar saltos de línea y comas dentro de los datos para evitar problemas en CSV
            const datos = Array.from(celdas).map(td => `"${td.innerText.replace(/"/g, '""').replace(/\n/g, ' ')}"`);
            csv += datos.join(',') + '\n';
        });

        // El tipo de Blob correcto para CSV es 'text/csv;charset=utf-8'
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'lista_riesgo.csv';
        a.click();
        
        // ⚠️ MEJORA: Liberar la URL del objeto Blob después de la descarga
        setTimeout(() => URL.revokeObjectURL(url), 100); 
    }

    // La llamada inicial para poblar la tabla. CORRECTO.
    mostrarClientes(clientes);
</script>

</body>
</html>